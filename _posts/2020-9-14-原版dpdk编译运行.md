<secret>DPDK安装和部署<secret>

0.0. 保证网卡安装在Socket 0 上

lspci |grep Ethernet

cat /sys/bus/pci/devices/0000\:3b\:00.0/numa_node 
cat /sys/bus/pci/devices/0000\:18\:00.3/numa_node

0.1. CentOS 7.6版本编译运行dpdk-17.05.2

**yum install svn**
**yum install gcc kernel-devel**
**yum install libpcap-devel**

cd dpdk-17.05.2
export RTE_SDK=`pwd`
export RTE_KERNELDIR=/usr/src/kernels/3.10.0-957.10.1.el7.x86_64
make config T=x86_64-generic-linuxapp-gcc
make -j64

1.下载源码并解压
当前最新版为dpdk-17.08.tar.xz
解压xz文件：
`xz -d dpdk-17.08.tar.xztar -xf dpdk-17.08.tar`

2.检查安装环境

- 确保系统是已安装linux kernel header，linux kernel版本号由系统本身决定，使用`uname -r`命令查看，kernel版本号必须大于2.6.33
- glibc版本号大于2.7
- libpcap函数库
- **查看kernel是否支持hugepages，如果出此CONFIG_HUGETLBFS=y，CONFIG_HUGETLB_PAGE=y则表示支持**
  **[root@localhost dpdk-17.08]# uname -r** 
  **3.10.0-229.el7.x86_64**
  **[root@localhost dpdk-17.08]# grep -i huge /boot/config-3.10.0-229.el7.x86_64** 
  **CONFIG_CGROUP_HUGETLB=y**
  **CONFIG_HAVE_ARCH_TRANSPARENT_HUGEPAGE=y**
  **CONFIG_TRANSPARENT_HUGEPAGE=y**
  **CONFIG_TRANSPARENT_HUGEPAGE_ALWAYS=y**
  **\#CONFIG_TRANSPARENT_HUGEPAGE_MADVISE is not set**
  **CONFIG_HUGETLBFS=y**
  **CONFIG_HUGETLB_PAGE=y**

3.编译安装
配置环境变量：
`export RTE_SDK=/home/dpdk/dpdk-17.08export RTE_TARGET=x86_64-native-linuxapp-gcc`

------

指定内核版本编译
wget https://mirrors.tripadvisor.com/centos-vault/7.5.1804/updates/x86_64/Packages/kernel-devel-3.10.0-862.14.4.el7.x86_64.rpm
rpm -ivh kernel-devel-3.10.0-862.14.4.el7.x86_64.rpm --force

export RTE_SDK=/home/liul/dpdk-stable-17.05.2
export RTE_TARGET=x86_64-generic-linuxapp-gcc
export RTE_KERNELDIR=/usr/src/kernels/3.10.0-862.14.4.el7.x86_64
make config T=x86_64-generic-linuxapp-gcc
make

完整的DPDK代码已经编译不过

------

编译安装：
`cd dpdk-17.08make install T=x86_64-native-linuxapp-gcc`
x86_64指x86构架64位系统。如果是32位系统，将x86_64替换为i686。
官网给出的编译平台规范是ARCH-MACHINE-EXECENV-TOOLCHAIN
ARCH can be: i686, x86_64, ppc_64
MACHINE can be: native, ivshmem, power8
EXECENV can be: linuxapp, bsdapp
TOOLCHAIN can be: gcc, icc
例如powerpc平台编译命令为：`make install T=ppc_64-power8-linuxapp-gcc`
也可以先设置，再编译
`make config T=x86_64-native-linuxapp-gccmake`
make install会将编译后的文件放入新建的x86_64-native-linuxapp-gcc目录。
make config + make会将编译后的文件放入新建的build目录

注1：这里会遇到一个问题/eal/eal_memory.c:56:18: fatal error: numa.h: No such file or directory
解决方法是yum install numactl-devel
注2：如果需要编译特定模块，需修改配置文件
cd /home/dpdk/dpdk-17.02/config
vi defconfig_x86_64-native-linuxapp-gcc

CONFIG_RTE_LIBRTE_BNX2X_PMD=y
CONFIG_RTE_LIBRTE_BNX2X_DEBUG=y
CONFIG_RTE_LIBRTE_BNX2X_DEBUG_INIT=y
CONFIG_RTE_LIBRTE_BNX2X_DEBUG_RX=y
CONFIG_RTE_LIBRTE_BNX2X_DEBUG_TX=y
CONFIG_RTE_LIBRTE_BNX2X_MF_SUPPORT=y
CONFIG_RTE_LIBRTE_BNX2X_DEBUG_PERIODIC=y

4.加载模块
`modprobe uio`
`insmod ${RTE_SDK}/x86_64-native-linuxapp-gcc/kmod/igb_uio.ko`
uio是kernel自带的用户空间IO模块
igb_uio是dpdk编译的模块，出现在dpdk-17.08/build/kmod 或者dpdk-17.08/x86_64-native-linuxapp-gcc/kmod 目录中。
（在新版本中可直接用sudo modprobe uio_pci_generic替代uio和igb_uio）

5.绑定网卡
查看网卡绑定信息：${RTE_SDK}/usertools/dpdk-devbind.py --status
[root@localhost config]# ${RTE_SDK}/usertools/dpdk-devbind.py --status

Network devices using DPDK-compatible driver ============================================
<none>

Network devices using kernel driver ===================================
0000:02:01.0 '82545EM Gigabit Ethernet Controller (Copper) 100f' if=eth0 drv=e1000 unused= **Active**
0000:02:05.0 '82545EM Gigabit Ethernet Controller (Copper) 100f' if=eth1 drv=e1000 unused=

Other Network devices =====================
<none>

绑定网卡：
`${RTE_SDK}/usertools/dpdk-devbind.py -b igb_uio 0000:02:05.0`
（在新版本中如果使用了uio_pci_generic，则把--bind=后的igb_uio换成uio_pci_generic）
绑定之前，保证网卡处于非活跃状态
`ifconfig eth1 down`

6.大页内存hugepage配置
查看当前系统hugepages信息：`grep -i huge /proc/meminfo`
对于2M的页面，通常是在系统启动之后进行设置。但是对于1G的页面，是不可能在系统启动之后进行设置的。
（1）hugepage设置
2M大内存页设置
对于双socket的NUMA机制，要分别对两个socket进行单独设置：
`echo 1024 > /sys/devices/system/node/node0/hugepages/hugepages-2048kB/nr_hugepagesecho 1024 > /sys/devices/system/node/node1/hugepages/hugepages-2048kB/nr_hugepages`

注：使用虚拟机测试时，由于虚拟机只有一个CPU，只需要设置node0，页数大小根据虚拟机内存进行设置，命令如下：
echo 256 > /sys/devices/system/node/node0/hugepages/hugepages-2048kB/nr_hugepages

**1G大内存页设置(2M内存页同样可以使用如下方法设置)**
**修改/etc/default/grub启动文件：`vi /etc/default/grub`** 
**[root@localhost ~]# vi /etc/default/grub** 
**GRUB_TIMEOUT=5**
**GRUB_DEFAULT=saved**
**GRUB_DISABLE_SUBMENU=true**
**GRUB_TERMINAL_OUTPUT="console"** 
**GRUB_CMDLINE_LINUX="crashkernel=auto rhgb quiet net.ifnames=0 biosdevname=0"** 
**GRUB_DISABLE_RECOVERY="true"** 
**修改GRUB_CMDLINE_LINUX，增加如下内容**
**default_hugepagesz=1G hugepagesz=1G hugepages=16 isolcpus=1-21,28-48 nohz_full=1-21,28-48 rcu_nocbs=1-21,28-48**

**default_hugepagesz=1G hugepagesz=1G hugepages=16配置16G大页内存**
**isolcpus=1-21,28-48 nohz_full=1-21,28-48 rcu_nocbs=1-21,28-48代表隔离CPU**

**然后运行 grub 更新并重启系统：**
**`grub2-mkconfig -o /boot/grub2/grub.cfg**`

**reboot**

**（2）hugepage挂载**
**上一步执行的是大页内存的预留，为了能够将其有效的使用，还需要进行挂载。**
**`mkdir /mnt/huge`**

**`mount -t hugetlbfs nodev /mnt/huge`**
**想要使得该挂载在系统每次启动时自动执行，将下列文本加入/etc/fstab里面去。**
**`nodev /mnt/huge hugetlbfs defaults 0 0`**
**对于1G的页面，页面大小必须在挂载时被显式指定**
**`nodev /mnt/huge_1GB hugetlbfs pagesize=1G 0 0`**

**配置完成后使用`grep -i huge /proc/meminfo`命令查看是否挂载成功**
**[root@localhost dpdk-17.08]# grep -i huge /proc/meminfo**
**AnonHugePages: 188416 kB**
**HugePages_Total: 512**
**HugePages_Free: 512**
**HugePages_Rsvd: 0**
**HugePages_Surp: 0**
**Hugepagesize: 2048 kB**

7.运行实例
运行helloworld示例
\#添加环境变量（如果已经配置过则此处不用添加）
`export RTE_SDK=/home/dpdk/dpdk-17.08export RTE_TARGET=x86_64-native-linuxapp-gcc`
\#编译
`cd /dpdk-17.08/example/helloworld`
make
\#运行
`./build/helloworld -c 3 -n 2`
hello from core 1
hello from core 0

[![Edit](https://192.168.9.161/images/edit.png)](https://192.168.9.161/projects/hili_auditor/wiki/DPDK安装和部署/edit?section=2)



### 附录1：采用pcap PMD`vi .config CONFIG_RTE_PORT_PCAP=y CONFIG_RTE_LIBRTE_PMD_PCAP=y 重新编译 $RTE_SDK/examples/packet_ordering/build/packet_ordering -c 0x07 -n 3 --vdev 'eth_pcap0,rx_pcap=/root/http.pcap,tx_pcap=/root/output0.pcap'   -- -p 1 `[![Edit](https://192.168.9.161/images/edit.png)](https://192.168.9.161/projects/hili_auditor/wiki/DPDK安装和部署/edit?section=3)

### 附录2：多进程关闭ASLR cat /proc/sys/kernel/randomize_va_space0 = 关闭 1 = 半随机。共享库、栈、mmap() 以及 VDSO 将被随机化。（留坑，PIE会影响heap的随机化。。） 2 = 全随机。除了1中所述，还有heap。vi /etc/sysctl.d/99-sysctl.conf  增加一行 kernel.randomize_va_space = 0及时生效 sysctl -p -w
